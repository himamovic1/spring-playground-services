FROM amazoncorretto:17.0.4-alpine AS base_stage
EXPOSE 8888

FROM gradle:7.5-jdk17-alpine as build_stage
ARG CONFIG_USER
ARG CONFIG_PASS
ARG CONFIG_GIT_REPO
ARG CONFIG_VAULT_URI
ARG CONFIG_VAULT_TOKEN

ENV SPRING_SECURITY_USER_NAME $CONFIG_USER
ENV SPRING_SECURITY_USER_PASSWORD $CONFIG_PASS
ENV SPRING_CLOUD_CONFIG_SERVER_GIT_URI $CONFIG_GIT_REPO
ENV SPRING_CLOUD_CONFIG_SERVER_VAULT_URI $CONFIG_VAULT_URI
ENV SPRING_CLOUD_CONFIG_SERVER_VAULT_TOKEN $CONFIG_VAULT_TOKEN
ENV APP_HOME /usr/app
WORKDIR $APP_HOME

COPY ./src $APP_HOME/src
COPY ./gradle $APP_HOME/gradle
COPY ./build.gradle ./settings.gradle $APP_HOME/

RUN gradle build --no-daemon

FROM base_stage AS final_stage
ENV ARTIFACT_NAME config-server-0.0.1-SNAPSHOT.jar
ENV APP_HOME /usr/app
WORKDIR $APP_HOME

COPY entrypoint.sh .
COPY --from=build_stage $APP_HOME/build/libs/$ARTIFACT_NAME ./$ARTIFACT_NAME

ENTRYPOINT [ "./entrypoint.sh" ]